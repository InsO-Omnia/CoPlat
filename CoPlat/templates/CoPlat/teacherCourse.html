<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>在线协同教学系统</title>
	<script src="../../static/jscss/jquery-2.1.4.min.js"></script>
	<script src="../../static/jscss/bootstrap.min.js"></script>
	<link rel="stylesheet" href="../../static/jscss/bootstrap.min.css">
	<link rel="stylesheet" href="../../static/jscss/style.css">
	<script src="../../static/jscss/my.js"></script>
	<script>
		//$(document).ready(teacherReady);
        // using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
 var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
		function displayCourseList(){
			//获取该教师的课程列表
			var url = 'teacher_courselist_response/';
		var teacherid = "t00001111"
    //getCookie('teacherid');
			var courselist = $('#courselist');
			$.post(url, {Teacherid: teacherid}).success(function(data){
				var json = eval('(' + data + ')');
				var str = '';
				var length = json.courses.length;
				for(var i = 0 ; i < length ; i++){
					str = str + '<li>' + '<button class="btn btn-link" style="padding: 0" onclick="displayCourseDetail(\'' + json.courses[i].CourseId + '\')">' + json.courses[i].CourseName + '</button>' +'</li>';
				}
				courselist.empty();
				courselist.append(str);
			});
		}
		function displayCourseDetail(courseid){
			//显示课程详细信息
			document.getElementById('displayedhomework').style.display = 'none';
			document.getElementById('deliverysource').style.display = 'none';
			document.getElementById('displayhomeworkdetail').style.display = 'none';
			document.getElementById('displayhomeworklist').style.display = 'none';
			document.getElementById('displaycourseid').style.display = 'block';
			document.getElementById('courseid').innerHTML = courseid;
			var url = 'teacher_coursedetails_response/';
			var cd = $('#coursedetail');
			$.post(url, {CourseId: courseid}).success(function(data){
                            
                            var json = eval('(' + data + ')');
				var coursename = json['CourseName'];
				var credit = json['Credit'];
				var weeks = json['Weeks'];
				var str = '';
				str = str + '<li>' + '课程名称：' + coursename + '</li>';
				str = str + '<li>' + '任课教师：' + '</li>';
				var length = json.Teacher.length;
				for(var i = 0 ; i < length ; i++){
					str = str + '<li>' + json.Teacher[i].TeacherId + ' ' + json.Teacher[i].TeacherName + '</li>';
				}
				str = str + '<li>' + '课程学分：' + credit + '</li>';
				str = str + '<li>' + '课程周数：' + weeks + '</li>';
				str = str + '<li>' + '<button class="btn btn-default btn-xs" onclick="diliverySource()">' + '发布资源</button>' + '</li>';
				str = str + '<li>' + '<button class="btn btn-default btn-xs" onclick="teacherHomework()">' + '管理作业</button>' + '</li>';
				cd.empty();
				cd.append(str);
			});
			document.getElementById('coursedetail').style.display = 'block';
		}
		function diliverySource(){
			document.getElementById('displayhomeworklist').style.display = 'none';
			//document.getElementById('coursedetail').style.display= 'none';
			document.getElementById('deliverysource').style.display = 'block';
			$('#uploadsource').val('');
			document.getElementById('uploadstatus').innerHTML = '';
		}
		function teacherHomework(){
			//获取该门课程的作业列表
			document.getElementById('displayedhomework').style.display = 'none';
			document.getElementById('coursedetail').style.display = 'none';
			document.getElementById('deliverysource').style.display = 'none';
			document.getElementById('addhomework').style.display = 'none';
			document.getElementById('displayhomeworklist').style.display = 'block';
			document.getElementById('homeworklist').style.display = 'block';
			var courseid = document.getElementById('courseid').innerHTML;
			var hl = $('#homeworklist');
			var url = 'courseworklist_response/';
			$.post(url,{CourseId: courseid}).success(function(data){
        var json = eval('(' + data + ')');
				var str = '';
				var length = getJsonLength(json);
				for(var i = 0 ; i < length ; i++){
					str = str + '<li>' + '<button class="btn btn-link btn-xs" onclick="homeworkDetail(\'' + json[i] + '\')">' + json[i] + '</button>' + '</li>';
				}
				hl.empty();
				hl.append(str);
			});
		}
		function displayAddHomework(){
			document.getElementById('displayedhomework').style.display = 'none';
			document.getElementById('displayhomeworkdetail').style.display = 'none';
			document.getElementById('homeworklist').style.display = 'none';
			document.getElementById('addhomework').style.display = 'block';
			$('#hdescription').val('');
			$('#hstarttime').val('');
			$('#hendtime').val('');
		}
		function addHomework(){
			//添加新作业
			var courseid = document.getElementById('courseid').innerHTML;
			var description = $('#hdescription').val();
			var starttime = $('#hstarttime').val();
			var endtime = $('#hendtime').val();
			if(description == '' || starttime == '' || endtime == ''){
				alert('请正确填写作业信息！');
				return;
			}
			var url = 'http://127.0.0.1/DemoWebApp/tpsuccess.php';
			$.post(url, {CourseId: courseid, Description: description, StartTime: starttime, EndTime: endtime}).success(function(data){
				var json = eval('(' + data + ')');
				if(json['Status'] == 'Success'){
					alert('作业添加成功！');
					displayAddHomework();
				}
				else if(json['Status'] == 'Fail'){
					alert('作业添加失败！请检查相关信息填写是否正确。');
				}
			});
		}
		function homeworkDetail(homeworkid){
			//获取作业详情
			document.getElementById('displayedhomework').style.display = 'none';
			document.getElementById('displayhomeworkdetail').style.display = 'block';
			document.getElementById('homeworkid').innerHTML = homeworkid;
			var hsl = $('#homeworkstudentlist');
			var url = 'coursework_studentlist_response/';
			$.post(url, {HomeworkId:homeworkid}).success(function(data){
                            var json = eval('(' + data + ')');
				document.getElementById('hddescription').innerHTML = '作业描述：' + json['Description'];
				document.getElementById('hdstarttime').innerHTML = '开始时间：' + json['StartTime'];
				document.getElementById('hdendtime').innerHTML = '结束时间：' + json['EndTime'];
				var studentlength = json['Students'].length;
				var str = '';
				for(var i = 0 ; i < studentlength ; i++){
					str = str + '<li>' + '<button class="btn btn-link" onclick="displayedhomework(\'' + json.Students[i].StudentId + '\')">' + json.Students[i].StudentId + '_' + json.Students[i].StudentName + '</button>' + '</li>';
				}
				hsl.empty();
				hsl.append(str);
			});
		}
		function displayedhomework(studentid){
			document.getElementById('displayedhomework').style.display = 'block';
			document.getElementById('studentid').innerHTML = studentid;
		}
		function downloadHomework(){
			                      //下载作业
        $.post('set_coursework_info/', {Studentid : "s11110000", Courseworkno : "000101"}).success(function(data){
        var json = eval('(' + data + ')');
        if(json['Status'] == 'Success'){
            window.location.href = "file_download_response/";
        }
        else {
            alert('Load Failure!');
        }
       }
      )
          
		}
		function submitComment(){
			//提交作业评论
			var commenttext = $('#comment').val();
			if(commenttext == ''){
				alert('请填写对本作业的评价后再提交！');
				return;
			}
			var studentid = document.getElementById('studentid').innerHTML;
			var homeworkid = document.getElementById('homeworkid').innerHTML;
			var url = 'http://127.0.0.1/DemoWebApp/tpsuccess.php';
			$.post(url, {CommentText: commenttext, StudentId: studentid, HomeworkId: homeworkid}).success(function(data){
				var json = eval('(' + data + ')');
				if(json['Status'] == 'Success'){
					alert('评价成功！');
				}
				else if(json['Status'] == 'Fail'){
					alert('评价失败！请稍候再试');
				}
			});
		}
		function uploadFile(){
			var si = document.getElementById('filetype').selectedIndex;
			var filetype = document.getElementById('filetype').options[si].value;
			var fileObj = document.getElementById('uploadsource').files[0];
			if(!checkFileType(filetype, getFileFormat(fileObj.name))){
				alert('文件格式不符，请重新选择！');
				return;
			}

			var fileController = '/CoPlat/resource_upload_response/';

			var courseid = document.getElementById('courseid').innerHTML;

			var form = new FormData();
			form.append("CourseId", courseid);
			form.append("Type", filetype);
			form.append("File", fileObj);

			form.enctype = 'multipart/form-data';

			var xhr = new XMLHttpRequest();
			xhr.open("post", fileController, true);
			xhr.onreadystatechange = function () {
				if(xhr.readyState == 4 && xhr.status == 200){
					var data = eval('(' + xhr.responseText + ')');
          var json = eval('(' + data + ')');
					if(json['Status'] == 'Success'){
						document.getElementById('uploadstatus').innerHTML = '<span style="color: green">文件上传成功！</span>';
					}
					else{
						document.getElementById('uploadstatus').innerHTML = '<span style="color: red">文件上传失败！</span>';
					}
				}
			};
			xhr.send(form);

		}
	</script>
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-md-7">
			<div id="title">
				在线协同教学系统
			</div>
		</div>
		<div class="col-md-5">
			<div id="userinfo">

			</div>
		</div>
	</div>
	<div id="nav">
		<div class="row">
			<div class="col-md-2">
				<div class="selecteditem">
					<a href="./teacherCourse.html" target="_self">查看课程</a>
				</div>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-2">
			<div id="maincontainerL">
				<button class="btn btn-default" onclick="displayCourseList()">查看课程</button>
				<ul id="courselist" style="margin-top:1.5rem"></ul>
			</div>
		</div>
		<div class="col-md-10">
			<div id="maincontainerR">
				<div class="row">
					<div class="col-md-3">
						<div id="displaycourseid" style="display: none">
							<label>当前课程ID：</label>
							<label id="courseid"></label>
						</div>
						<div id="coursedetail" style="display: none"></div>
						<div id="displayhomeworklist" style="display: none">
							<div class="form-group">
								<button class="btn btn-default" onclick="displayAddHomework()">添加新作业</button>
							</div>
							<ul id="homeworklist"></ul>
							<div id="addhomework" style="display: none">
								<div class="form-group">
									<label for="hdescription">作业描述</label>
									<textarea id="hdescription" rows="3"></textarea>
								</div>
								<div class="form-group">
									<label for="hstarttime">起始时间</label>
									<input type="date" id="hstarttime">
								</div>
								<div class="form-group">
									<label for="hendtime">结束时间</label>
									<input type="date" id="hendtime">
								</div>
								<div class="form-group">
									<button class="btn btn-default" onclick="addHomework()">提交</button>
								</div>
							</div>
						</div>
						<div id="communication" style="display: none"></div>
					</div>
					<div class="col-md-5">
						<div id="deliverysource" style="display: none">
							<div class="form-group">
								<div class="form-group">
									<label for="filetype">选择要上传的文件类型：</label>
									<select id="filetype">
										<option value="HA">课件[.ppt/.pptx/.pdf]</option>
										<option value="DO">文档[.doc/.docx/.pdf]</option>
										<option value="VE">视频[.mp4]</option>
										<option value="UN">其他文件</option>
									</select>
								</div>
								<input type="file" id="uploadsource">
								<p id="uploadstatus"></p>
							</div>
							<button class="btn btn-default" onclick="uploadFile()">提交</button>
						</div>
						<div id="displayhomeworkdetail" style="display: none">
							<label>当前作业ID：</label>
							<label id="homeworkid"></label>
							<ul id="homeworkdetail">
								<li id="hddescription"></li>
								<li id="hdstarttime"></li>
								<li id="hdendtime"></li>
								<li>已上交作业的学生列表，点击可查看、评论该学生作业：</li>
							</ul>
							<ul id="homeworkstudentlist"></ul>
						</div>
					</div>
					<div class="col-md-4">
						<div id="displayedhomework" style="display: none">
							<label>当前学生学号：</label>
							<label id="studentid"></label>
							<div class="form-group">
								<button class="btn btn-link" onclick = "downloadHomework()">下载作业</button>
							</div>
							<div class="form-group">
								<label for="comment">评论：</label>
								<textarea class="form-control" rows="3" id="comment"></textarea>
							</div>
							<div class="form-group">
								<button class="btn btn-default" onclick="submitComment()">提交评论</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

</body>
</html>
